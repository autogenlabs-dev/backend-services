<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Backend Integration Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .auth-section {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .auth-form {
            flex: 1;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .auth-form h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .user-info {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .oauth-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .oauth-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: background 0.2s;
        }
        
        .oauth-btn:hover {
            background: #f0f0f0;
        }
        
        .test-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .test-results {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .test-results.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .test-results.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó Frontend-Backend Integration Test</h1>
            <p>Testing real frontend integration with User Management Backend</p>
        </div>
        
        <div class="content">
            <div class="auth-section">
                <!-- Registration Form -->
                <div class="auth-form">
                    <h3>üìù Register</h3>
                    <form id="registerForm">
                        <div class="input-group">
                            <label for="regEmail">Email:</label>
                            <input type="email" id="regEmail" value="test@example.com" required>
                        </div>
                        <div class="input-group">
                            <label for="regName">Name:</label>
                            <input type="text" id="regName" value="Test User" required>
                        </div>
                        <div class="input-group">
                            <label for="regPassword">Password:</label>
                            <input type="password" id="regPassword" value="testpassword123" required>
                        </div>
                        <button type="submit" class="btn">Register</button>
                    </form>
                    <div id="registerStatus"></div>
                </div>
                
                <!-- Login Form -->
                <div class="auth-form">
                    <h3>üîê Login</h3>
                    <form id="loginForm">
                        <div class="input-group">
                            <label for="loginEmail">Email:</label>
                            <input type="email" id="loginEmail" value="test@example.com" required>
                        </div>
                        <div class="input-group">
                            <label for="loginPassword">Password:</label>
                            <input type="password" id="loginPassword" value="testpassword123" required>
                        </div>
                        <button type="submit" class="btn">Login</button>
                    </form>
                    <div id="loginStatus"></div>
                </div>
            </div>
            
            <!-- OAuth Section -->
            <div class="test-section">
                <h3>üîó OAuth Login</h3>
                <div class="oauth-buttons">
                    <div class="oauth-btn" onclick="oauthLogin('google')">
                        üå≥ Google Login
                    </div>
                    <div class="oauth-btn" onclick="oauthLogin('github')">
                        üêô GitHub Login
                    </div>
                    <div class="oauth-btn" onclick="oauthLogin('openrouter')">
                        üöÄ OpenRouter Login
                    </div>
                </div>
                <div id="oauthStatus"></div>
            </div>
            
            <!-- User Profile Section -->
            <div class="test-section">
                <h3>üë§ User Profile</h3>
                <button class="btn" onclick="getUserProfile()">Get My Profile</button>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
                <div id="profileStatus"></div>
                <div id="userInfo" class="user-info" style="display: none;"></div>
            </div>
            
            <!-- API Test Section -->
            <div class="test-section">
                <h3>üîå API Tests</h3>
                <button class="btn" onclick="testAPIKeys()">Test API Keys</button>
                <button class="btn" onclick="testTemplates()">Test Templates</button>
                <button class="btn" onclick="testHealth()">Test Health</button>
                <button class="btn" onclick="testDashboardNavigation()">Test Dashboard Navigation</button>
                <button class="btn" onclick="testFullAPIIntegration()">Test Full API Integration</button>
                <div id="apiTestResults" class="test-results"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let authToken = localStorage.getItem('authToken') || null;

        // Show status message
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    element.innerHTML = '';
                }, 5000);
            }
        }

        // Show test results
        function showTestResults(message, success) {
            const resultsDiv = document.getElementById('apiTestResults');
            resultsDiv.className = `test-results ${success ? 'success' : 'error'}`;
            resultsDiv.textContent = message;
        }

        // HTTP request helper
        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` }),
                        ...options.headers
                    },
                    ...options
                });
                
                let data;
                try {
                    data = await response.json();
                } catch {
                    data = await response.text();
                }
                
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Registration
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('regEmail').value;
            const name = document.getElementById('regName').value;
            const password = document.getElementById('regPassword').value;
            
            const result = await makeRequest(`${API_BASE}/api/auth/register`, {
                method: 'POST',
                body: JSON.stringify({ email, name, password })
            });
            
            if (result.success) {
                showStatus('registerStatus', '‚úÖ Registration successful! You can now login.', 'success');
            } else {
                showStatus('registerStatus', `‚ùå Registration failed: ${result.error || 'Unknown error'}`, 'error');
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const result = await makeRequest(`${API_BASE}/api/auth/login-json`, {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
            
            if (result.success && result.data.access_token) {
                authToken = result.data.access_token;
                localStorage.setItem('authToken', authToken);
                showStatus('loginStatus', '‚úÖ Login successful! Token stored.', 'success');
                updateUIForLoggedInUser();
            } else {
                showStatus('loginStatus', `‚ùå Login failed: ${result.error || 'Invalid credentials'}`, 'error');
            }
        });

        // OAuth Login
        async function oauthLogin(provider) {
            try {
                const result = await makeRequest(`${API_BASE}/api/auth/${provider}/login`, {
                    redirect: 'manual'
                });
                
                if (result.status === 302 || result.status === 307) {
                    showStatus('oauthStatus', `‚úÖ ${provider} OAuth redirect working! Opening login window...`, 'success');
                    // Open OAuth login in popup window
                    const popup = window.open(
                        `${API_BASE}/api/auth/${provider}/login`,
                        '_blank',
                        'width=500,height=600,scrollbars=yes,resizable=yes'
                    );
                    
                    // Monitor popup for closure (in real app, you'd handle callback)
                    const checkClosed = setInterval(() => {
                        if (popup.closed) {
                            clearInterval(checkClosed);
                            showStatus('oauthStatus', `‚ÑπÔ∏è ${provider} OAuth login window closed`, 'info');
                        }
                    }, 1000);
                    
                    // Auto-close after 2 minutes
                    setTimeout(() => {
                        if (!popup.closed) {
                            popup.close();
                            clearInterval(checkClosed);
                            showStatus('oauthStatus', `‚ÑπÔ∏è ${provider} OAuth login timed out`, 'info');
                        }
                    }, 120000);
                } else {
                    showStatus('oauthStatus', `‚ùå ${provider} OAuth failed: Status ${result.status}`, 'error');
                }
            } catch (error) {
                showStatus('oauthStatus', `‚ùå ${provider} OAuth error: ${error.message}`, 'error');
            }
        }

        // Get User Profile
        async function getUserProfile() {
            if (!authToken) {
                showStatus('profileStatus', '‚ùå Please login first', 'error');
                return;
            }
            
            const result = await makeRequest(`${API_BASE}/api/users/me`);
            
            if (result.success) {
                const userInfo = document.getElementById('userInfo');
                userInfo.innerHTML = `
                    <h4>üë§ User Profile Data:</h4>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `;
                userInfo.style.display = 'block';
                showStatus('profileStatus', '‚úÖ Profile retrieved successfully!', 'success');
            } else {
                showStatus('profileStatus', `‚ùå Failed to get profile: ${result.error || 'Unknown error'}`, 'error');
            }
        }

        // Logout
        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            document.getElementById('userInfo').style.display = 'none';
            showStatus('profileStatus', '‚úÖ Logged out successfully!', 'success');
            updateUIForLoggedOutUser();
        }

        // API Tests
        async function testAPIKeys() {
            if (!authToken) {
                showTestResults('‚ùå Please login first to test protected endpoints', false);
                return;
            }
            
            const result = await makeRequest(`${API_BASE}/api/api-keys/`);
            showTestResults(`API Keys Test: ${result.success ? 'SUCCESS' : 'FAILED'}\n${JSON.stringify(result.data, null, 2)}`, result.success);
        }

        async function testTemplates() {
            const result = await makeRequest(`${API_BASE}/api/templates/`);
            showTestResults(`Templates Test: ${result.success ? 'SUCCESS' : 'FAILED'}\n${JSON.stringify(result.data, null, 2)}`, result.success);
        }

        async function testHealth() {
            const result = await makeRequest(`${API_BASE}/health`);
            showTestResults(`Health Check: ${result.success ? 'SUCCESS' : 'FAILED'}\n${JSON.stringify(result.data, null, 2)}`, result.success);
        }

        // Update UI based on auth state
        function updateUIForLoggedInUser() {
            document.querySelector('.auth-section').style.opacity = '0.6';
        }

        function updateUIForLoggedOutUser() {
            document.querySelector('.auth-section').style.opacity = '1';
        }

        // Dashboard Navigation Test
        async function testDashboardNavigation() {
            showTestResults('Testing Dashboard Navigation...', true, 'Opening API documentation in new tab');
            
            // Open API documentation in new tab
            window.open(`${API_BASE}/docs`, '_blank');
            
            // Test navigation to different endpoints
            setTimeout(async () => {
                const endpoints = [
                    '/api/auth/providers',
                    '/api/users/me',
                    '/api/api-keys/',
                    '/api/templates/'
                ];
                
                for (const endpoint of endpoints) {
                    const result = await makeRequest(`${API_BASE}${endpoint}`);
                    console.log(`Endpoint ${endpoint}:`, result.success ? '‚úÖ' : '‚ùå');
                }
                
                showTestResults('Dashboard Navigation Test Complete', true,
                    `Tested ${endpoints.length} endpoints for navigation`);
            }, 1000);
        }

        // Full API Integration Test
        async function testFullAPIIntegration() {
            if (!authToken) {
                showTestResults('‚ùå Please login first for full API integration test', false);
                return;
            }
            
            showTestResults('Testing Full API Integration...', true,
                'Testing complete API workflow with authentication');
            
            try {
                // 1. Get user profile
                const profileResult = await makeRequest(`${API_BASE}/api/users/me`);
                
                // 2. Create API key
                const apiKeyResult = await makeRequest(`${API_BASE}/api/api-keys/`, {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'Test API Key',
                        description: 'API key for testing',
                        expires_in_days: 30
                    })
                });
                
                // 3. List templates
                const templatesResult = await makeRequest(`${API_BASE}/api/templates/`);
                
                // 4. Test token usage logging
                const usageResult = await makeRequest(`${API_BASE}/api/users/me/token-usage`, {
                    method: 'POST',
                    body: JSON.stringify({
                        provider: 'test',
                        model_name: 'test-model',
                        tokens_used: 100,
                        request_type: 'test',
                        request_metadata: { test: true }
                    })
                });
                
                // 5. Get VS Code configuration
                const vscodeResult = await makeRequest(`${API_BASE}/api/auth/vscode-config`);
                
                const allTestsPassed = profileResult.success &&
                                       apiKeyResult.success &&
                                       templatesResult.success &&
                                       usageResult.success &&
                                       vscodeResult.success;
                
                showTestResults('Full API Integration Test', allTestsPassed,
                    `Profile: ${profileResult.success ? '‚úÖ' : '‚ùå'}, ` +
                    `API Key: ${apiKeyResult.success ? '‚úÖ' : '‚ùå'}, ` +
                    `Templates: ${templatesResult.success ? '‚úÖ' : '‚ùå'}, ` +
                    `Usage: ${usageResult.success ? '‚úÖ' : '‚ùå'}, ` +
                    `VS Code: ${vscodeResult.success ? '‚úÖ' : '‚ùå'}`);
                
                return allTestsPassed;
            } catch (error) {
                showTestResults('Full API Integration Test', false, `Error: ${error.message}`);
                return false;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                updateUIForLoggedInUser();
            }
        });
    </script>
</body>
</html>